<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1 user-scalable=no">
    <title>Pumpkin Thief</title>
    <style>
      * { padding: 0; margin: 0; }
      canvas { background: url("street.png"); display: block; margin: 0 auto; }
      .game-wrapper {
        width: 320px;
        margin: 10px auto;
      }
      .btn {
        float: left;
        width: 100px;
        height: 100px;
        border-radius: 50px;
        /*background: #FDE74C;*/
      }
      .left {
        background-image: url("left.png");
      }
      .right {
        background-image: url("right.png");
      }
      .restart {
        background-image: url("restart.png");
      }
      .game-over {
        text-align: center;
      }
    </style>
</head>
<body>

<div class="game-wrapper">
  <canvas id="myCanvas" width="320" height="360"></canvas>
  <div id="controls" class="controls">
    <div class="btn left" onclick="moveLeft()" style="margin-left: 30px;"></div>
    <div class="btn right" onclick="moveRight()" style="margin-left: 60px;"></div>
  </div>
  <div id="gameOver" class="game-over" style="display: none;">
    <div id="score"></div>
    <div class="btn restart" onclick="restart()" style="margin-left: 110px;"></div>
  </div>
  <audio id="audioHit" src="hit.wav" style="display:none"></audio>
</div>

<script>
  var canvas = document.getElementById("myCanvas");
  var ctx = canvas.getContext("2d");

  var controlsAreaWidth = 320;
  var controlsAreaHeight = 120;
  var controlsAreaOffsetTop = 360;

  var playerHeight = canvas.height/4; // @TODO unhardcode 4
  var playerWidth = canvas.width/2; // @TODO unhardcode 2
  var playerPosition = [true, false];
  var playerX = 0;
  var playerReady = false;
  var playerImage = new Image();
  playerImage.onload = function () {
    playerReady = true;
  };
  playerImage.src = "player.png";

  var explosionImage = new Image();
  explosionImage.onload = function () {
    explosionReady = true;
  };
  explosionImage.src = "explosion.png";

  var canX, canY;
  var rightPressed = false;
  var leftPressed = false;
  var fired = 0;
  var score = 0;
  var gameOver = false;
  var hit = document.getElementById("audioHit");
  var sound = true;

  var pumpkinRowCount = 4;
  var pumpkinColumnCount = 2;
  var pumpkinWidth = canvas.width/pumpkinColumnCount;
  var pumpkinHeight = canvas.height/pumpkinRowCount;
  // var pumpkinPadding = 10;
  // var pumpkinOffsetTop = 30;
  // var pumpkinOffsetLeft = 30;
  var pumpkins = [];

  var pumpkinsReady = false;
  var pumpkinsImage = new Image();
  pumpkinsImage.onload = function () {
    pumpkinsReady = true;
  };
  pumpkinsImage.src = "pumpkin.png";

  var carsReady = false;
  var carsImage = new Image();
  carsImage.onload = function () {
    carsReady = true;
  };
  carsImage.src = "car.png";

  function endGame() {
    gameOver = true;
    hit.play();
    document.getElementById("controls").style.display = 'none';
    document.getElementById("gameOver").style.display = '';
    document.getElementById("score").innerHTML = "Your score: " + score;
  }

  function restart() {
    document.location.reload();
  }

  function generateRow() {
    var a = !!Math.floor(Math.random() * 2);
    var b = !a;
    a = a + 1;
    b = b + 1;
    if (pumpkins.length < 2) {
      return [0, 0];
    } else if (pumpkins[0][0] != a && pumpkins[0][1] != b) {
      return [1, 1];
    }
    return [a, b];
  }

  function movePumpkins() {
    pumpkins.unshift(generateRow());
    pumpkins.pop();
    collectPumpkins();
  }

  function collectPumpkins() {
    if ( pumpkins[3][0] == playerPosition[0] ) {
      pumpkins[3][0] = 0;
      score++;
    }
    if ( pumpkins[3][1] == playerPosition[1] ) {
      pumpkins[3][1] = 0;
      score++;
    }
  }

  for(i=0; i<pumpkinRowCount; i++) {
    pumpkins.unshift(generateRow());
  }

  document.addEventListener("keydown", keyDownHandler, false);
  document.addEventListener("keyup", keyUpHandler, false);

  function keyDownHandler(e) {
    if(!fired) {
      if(e.keyCode == 39) {
        moveRight();
      }
      else if(e.keyCode == 37) {
        moveLeft();
      }

      fired = true;
    }
  }

  function keyUpHandler(e) {
    fired = false;
  }

  function moveLeft() {
    if (!gameOver){
      var forward = playerPosition[0];
      playerX = 0;
      playerPosition = [true, false];
      collectPumpkins();
      if ( forward ) movePumpkins();
    }
  }

  function moveRight() {
    if (!gameOver){
      var forward = playerPosition[1];
      playerX = canvas.width/2;
      playerPosition = [false, true];
      collectPumpkins();
      if ( forward ) movePumpkins();
    }
  }

  function drawPlayer() {
    var x = playerX + 40;
    var y = canvas.height-playerHeight;
    ctx.drawImage(playerImage, x, y);
  }

  function drawExplosion() {
    var x = playerX + 40;
    var y = canvas.height-playerHeight;
    ctx.drawImage(explosionImage, x, y);
  }

  function drawPumpkins() {
    for(c=0; c<pumpkinRowCount; c++) {
      for(r=0; r<pumpkinColumnCount; r++) {
        if ( pumpkins[c][r] === 2 ) {
          var pumpkinX = 0 + canvas.width/2*r + 40;
          var pumpkinY = (canvas.height/pumpkinRowCount)*c;
          ctx.drawImage(carsImage, pumpkinX, pumpkinY);
        } else if ( pumpkins[c][r] === 1 ) {
          var pumpkinX = 0 + canvas.width/2*r + 40;
          var pumpkinY = (canvas.height/pumpkinRowCount)*c;
          ctx.drawImage(pumpkinsImage, pumpkinX, pumpkinY);
        }
      }
    }

    if (!gameOver && pumpkins.length === 4 && pumpkins[3][0] === 2 && playerPosition[0] == true ) {
      endGame();
    }
    if (!gameOver && pumpkins.length === 4 && pumpkins[3][1] === 2 && playerPosition[1] == true ) {
      endGame();
    }
  }

  function drawScore() {
    ctx.font = "16px Arial";
    ctx.fillStyle = "#FC2036";
    ctx.fillText("Score: " + score, 126, 20);
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawScore();

    if (playerReady && pumpkinsReady && carsReady && explosionReady) {
      if (!gameOver) {
        drawPumpkins();
        drawPlayer();
      } else {
        drawPumpkins();
        drawExplosion();
      }
    }

    requestAnimationFrame(draw);
  }

  draw();
</script>

</body>
</html>