<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1 user-scalable=no">
    <title>Pumpkin Thief</title>
    <style>
      * { padding: 0; margin: 0; }
      canvas { background: url("street.png"); display: block; margin: 0 auto; }
      .controls {
        width: 320px;
        margin: 10px auto;
      }
      .controls .btn {
        float: left;
        width: 100px;
        height: 100px;
        border-radius: 50px;
        background: #FDE74C;
      }
    </style>
</head>
<body>

<canvas id="myCanvas" width="320" height="360"></canvas>
<div class="controls">
  <div class="btn" onclick="moveLeft()" style="margin-left: 30px;"></div>
  <div class="btn" onclick="moveRight()" style="margin-left: 60px;"></div>
</div>

<script>
  var canvas = document.getElementById("myCanvas");
  var ctx = canvas.getContext("2d");

  var controlsAreaWidth = 320;
  var controlsAreaHeight = 120;
  var controlsAreaOffsetTop = 360;

  var playerHeight = canvas.height/4; // @TODO unhardcode 4
  var playerWidth = canvas.width/2; // @TODO unhardcode 2
  var playerPosition = [true, false];
  var playerX = 0;
  var playerReady = false;
  var playerImage = new Image();
  playerImage.onload = function () {
    playerReady = true;
  };
  playerImage.src = "player.png";

  var canX, canY;
  var rightPressed = false;
  var leftPressed = false;
  var fired = 0;
  var score = 0;

  var pumpkinRowCount = 4;
  var pumpkinColumnCount = 2;
  var pumpkinWidth = canvas.width/pumpkinColumnCount;
  var pumpkinHeight = canvas.height/pumpkinRowCount;
  // var pumpkinPadding = 10;
  // var pumpkinOffsetTop = 30;
  // var pumpkinOffsetLeft = 30;
  var pumpkins = [];

  var pumpkinsReady = false;
  var pumpkinsImage = new Image();
  pumpkinsImage.onload = function () {
    pumpkinsReady = true;
  };
  pumpkinsImage.src = "pumpkin.png";

  var carsReady = false;
  var carsImage = new Image();
  carsImage.onload = function () {
    carsReady = true;
  };
  carsImage.src = "car.png";

  function generateRow() {
    var a = !!Math.floor(Math.random() * 2);
    var b = !a;
    if (pumpkins.length < 2) {
      a = false;
      b = false;
    } else if (pumpkins[0][0] != a && pumpkins[0][1] != b) {
      a = false;
      b = false;
    }
    return [a, b];
  }

  function movePumpkins() {
    pumpkins.unshift(generateRow());
    pumpkins.pop();
  }

  function collectPumpkins() {
    console.log(playerPosition);
    console.log(pumpkins[3]);
    // pumpkins[3]
  }

  for(i=0; i<pumpkinRowCount; i++) {
    pumpkins.unshift(generateRow());
  }

  document.addEventListener("keydown", keyDownHandler, false);
  document.addEventListener("keyup", keyUpHandler, false);

  function keyDownHandler(e) {
    if(!fired) {
      if(e.keyCode == 39) {
        moveRight();
      }
      else if(e.keyCode == 37) {
        moveLeft();
      }

      fired = true;
    }
  }

  function keyUpHandler(e) {
    fired = false;
  }

  function moveLeft() {
    var forward = playerPosition[0];
    playerX = 0;
    playerPosition = [true, false];
    collectPumpkins();
    if ( forward ) {
      movePumpkins();
      score++;
    }
  }

  function moveRight() {
    var forward = playerPosition[1];
    playerX = canvas.width/2;
    playerPosition = [false, true];
    collectPumpkins()
    if ( forward ) {
      movePumpkins();
      score++;
    }
  }

  function drawPlayer() {
    var x = playerX + 40;
    var y = canvas.height-playerHeight;
    ctx.drawImage(playerImage, x, y);
  }

  function drawPumpkins() {
    for(c=0; c<pumpkinRowCount; c++) {
      for(r=0; r<pumpkinColumnCount; r++) {
        if (pumpkins[c][r]) {
          var pumpkinX = 0 + canvas.width/2*r + 40;
          var pumpkinY = (canvas.height/pumpkinRowCount)*c;
          ctx.drawImage(carsImage, pumpkinX, pumpkinY);
        } else {
          var pumpkinX = 0 + canvas.width/2*r + 40;
          var pumpkinY = (canvas.height/pumpkinRowCount)*c;
          ctx.drawImage(pumpkinsImage, pumpkinX, pumpkinY);
        }
      }
    }

    if (pumpkins.length === 4 && pumpkins[3].every(function(element, index) { return element === playerPosition[index]; })) {
      alert("GAME OVER \n Your score: " + score);
      document.location.reload();
    }
  }

  function drawScore() {
    ctx.font = "16px Arial";
    ctx.fillStyle = "#0095DD";
    ctx.fillText("Score: "+score, 8, 20);
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawScore();

    if (playerReady && pumpkinsReady && carsReady) {
      drawPumpkins();
      drawPlayer();
    }

    requestAnimationFrame(draw);
  }

  draw();
</script>

</body>
</html>